<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Panorama 360° + GLB</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; }
    #pano, #renderCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }
    canvas {
      pointer-events: none; /* permet à Marzipano de recevoir les clics */
    }
  </style>
</head>
<body>

  <div id="pano"></div>
  <canvas id="renderCanvas"></canvas>

  <!-- Marzipano -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marzipano/0.9.1/marzipano.js"></script>

  <!-- Babylon.js -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <script>
    // --- Marzipano: setup panorama ---
    const panoElement = document.getElementById('pano');
    const viewer = new Marzipano.Viewer(panoElement);
    const source = Marzipano.ImageUrlSource.fromString("panthere.png");
    const geometry = new Marzipano.EquirectGeometry([{ width: 4000 }]);
    const limiter = Marzipano.RectilinearView.limit.traditional(1024, 100 * Math.PI / 180);
    const view = new Marzipano.RectilinearView({ yaw: 0, pitch: 0, fov: Math.PI / 2 }, limiter);
    const scene = viewer.createScene({ source, geometry, view });
    scene.switchTo();

    // --- Babylon.js: setup 3D scene overlaid ---
    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true, { alpha: true });
    const scene3D = new BABYLON.Scene(engine);
    const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 0, 0), scene3D);
    camera.minZ = 0.1;
    camera.maxZ = 1000;
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene3D);

    // Charger le modèle GLB
    let model;
    BABYLON.SceneLoader.Append("./", "socleetoiletoque.glb", scene3D, () => {
      model = scene3D.meshes[scene3D.meshes.length - 1];
      model.position = new BABYLON.Vector3(0, 0, -5); // devant la caméra
      model.scaling = new BABYLON.Vector3(1, 1, 1);
    });

    // Synchronisation caméra
    engine.runRenderLoop(() => {
      const yaw = view.yaw();
      const pitch = view.pitch();
      const fov = view.fov();

      // Convert yaw/pitch to direction vector
      const x = Math.cos(pitch) * Math.sin(yaw);
      const y = Math.sin(pitch);
      const z = -Math.cos(pitch) * Math.cos(yaw);

      camera.fov = fov;
      camera.setTarget(new BABYLON.Vector3(x, y, z));

      scene3D.render();
    });

    window.addEventListener("resize", () => {
      engine.resize();
    });
  </script>

</body>
</html>
